
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Vindhu</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body data-mode="admin">
<div class="layout-container" id="layoutContainer"></div>

<script>
const DEFAULT_PROFILE_ICON = "data:image/svg+xml;utf8,"+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><circle cx='100' cy='50' r='30' fill='green' /><path d='M30 160 L45 115 100 80 155 115 170 160 Z' fill='green' /></svg>`);
document.addEventListener("DOMContentLoaded", ()=>{
  const layout = document.getElementById("layoutContainer");
  const ALLOWED_TYPES = ["image/jpeg","image/png","image/webp"];
  const DEFAULT_MAX_DISHES = 3;
  const vendors = [];
/* ===== Header ===== */
const header = document.createElement("header");
header.className = "app-header";
header.style.display = "flex";
header.style.alignItems = "center";
header.style.justifyContent = "space-between";
header.style.padding = "10px 20px";
header.style.backgroundColor = "#f9f9f9";
header.style.boxShadow = "0 2px 6px rgba(0,0,0,0.1)";

/* ===== Left side: Profile + Logo + Title ===== */
const headerLeft = document.createElement("div");
headerLeft.className = "header-left";
headerLeft.style.display = "flex";
headerLeft.style.alignItems = "center";
headerLeft.style.gap = "12px";

/* --- Profile button --- */
const profileTrigger = document.createElement("button");
profileTrigger.style.border = "none";
profileTrigger.style.background = "transparent";
profileTrigger.style.cursor = "pointer";

const profileIcon = document.createElement("img");
profileIcon.src = DEFAULT_PROFILE_ICON;
profileIcon.className = "profile-icon";
profileIcon.style.width = "50px";
profileIcon.style.height = "50px";
profileIcon.style.borderRadius = "50%";

profileTrigger.appendChild(profileIcon);
headerLeft.appendChild(profileTrigger);

/* --- Logo + Title Wrapper --- */
const titleWrapper = document.createElement("div");
titleWrapper.style.display = "flex";
titleWrapper.style.flexDirection = "column"; // stack vertically
titleWrapper.style.alignItems = "center";    // center horizontally
titleWrapper.style.gap = "4px";             // space between logo and title
titleWrapper.style.cursor = "pointer";
titleWrapper.style.maxWidth = "80px";       // match logo width
titleWrapper.style.overflow = "hidden";

/* --- SVG Logo --- */
const logo = document.createElementNS("http://www.w3.org/2000/svg", "svg");
logo.setAttribute("viewBox", "0 0 202 202");
logo.setAttribute("width", "50");  // logo width
logo.setAttribute("height", "50"); // logo height
logo.setAttribute("preserveAspectRatio", "xMidYMid meet");
logo.innerHTML = `
  <g id="gridContent">
    <rect x="0" y="0" width="202" height="202" fill="none"/>
    <path d="M 35 95 L 41 104 50 110 60 115 105 120 145 115 165 105 170 95 165 130 130 150 75 150 40 130 35 95" 
          fill="orange" stroke="red" stroke-width="2"/>
    <path d="M 130 150 L 133 152 133 155 130 157 75 157 72 155 72 152 75 150" 
          fill="orange" stroke="red" stroke-width="1"/>
    <path d="M 130 157 L 135 165 70 165 75 157" 
          fill="orange" stroke="red" stroke-width="2"/>
    <path d="M 35 95 L 37 91 38 87 41 85 43 81 45 79 46 76 50 73 55 71 57 69 60 66 65 64 69 60 75 59 80 59 85 57 90 56 100 54 110 54 115 55 120 56 125 58 130 59 115 67 100 66 95 66 90 67 95 70 96 75 101 80 103 85 106 87 106 90 109 95 113 89 115 86 120 76 135 67 150 58 155 55 156 60 160 61 165 59 167 54 166 50 160 47 159 40 155 36 150 36 146 40 146 45 149 48 130 59" 
          fill="none" stroke="red" stroke-width="2"/>
    <path d="M115 67 L 100 66 95 66 90 67 95 70 96 75 101 80 103 85 106 87 106 90 109 95 113 89 115 86 120 76 115 75 115 70 110 70 115 67" 
          fill="red" stroke="red" stroke-width="1"/>
    <path d="M 120 67 L 146 52" fill="none" stroke="red" stroke-width="2"/>
    <path d="M 125 70 L 147 57" fill="none" stroke="red" stroke-width="2"/>
    <path d="M 149 43 L 151 39 155 40 157 42" fill="none" stroke="red" stroke-width="2"/>
    <path d="M 160 51 L 165 53 163 58 160 58" fill="none" stroke="red" stroke-width="1"/>
    <path d="M 170 95 L 166 90 165 85 162 80 160 75 155 70 150 67 145 65 143 63" fill="none" stroke="red" stroke-width="1"/>
  </g>
`;
logo.addEventListener("click", () => window.location.reload());

/* --- Title Text --- */
const titleText = document.createElement("div");
titleText.innerText = "MY VINDHU";
titleText.style.fontFamily = "Verdana, sans-serif";
titleText.style.fontSize = "14px";  // smaller since below logo
titleText.style.fontWeight = "bold";
titleText.style.color = "red";
titleText.style.textAlign = "center";
titleText.style.whiteSpace = "nowrap";
titleText.style.overflow = "hidden";
titleText.style.textOverflow = "ellipsis";

/* --- Append Logo + Title --- */
titleWrapper.appendChild(logo);
titleWrapper.appendChild(titleText);
headerLeft.appendChild(titleWrapper);

/* ===== Right side ===== */
const headerRight = document.createElement("div");
headerRight.className = "header-right";
headerRight.style.display = "flex";
headerRight.style.alignItems = "center";
headerRight.style.gap = "16px";

/* ===== Dark/Light Toggle Button ===== */
const themeToggle = document.createElement("button");
themeToggle.id = "themeToggle";
themeToggle.style.cursor = "pointer";
themeToggle.style.border = "none";
themeToggle.style.background = "transparent";
themeToggle.style.padding = "6px";
themeToggle.style.display = "flex";
themeToggle.style.alignItems = "center";
themeToggle.style.justifyContent = "center";

const themeIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
themeIcon.setAttribute("id", "themeIcon");
themeIcon.setAttribute("width", "22");
themeIcon.setAttribute("height", "22");
themeIcon.setAttribute("viewBox", "0 0 24 24");
themeIcon.setAttribute("fill", "none");
themeIcon.setAttribute("stroke", "currentColor");
themeIcon.setAttribute("stroke-width", "2");
themeIcon.setAttribute("stroke-linecap", "round");
themeIcon.setAttribute("stroke-linejoin", "round");
themeIcon.innerHTML = `
  <circle cx="12" cy="12" r="5"></circle>
  <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42
           M18.36 18.36l1.42 1.42M1 12h2M21 12h2
           M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
`;
themeToggle.appendChild(themeIcon);
headerRight.appendChild(themeToggle);

/* ===== Donation Coin with Hand ===== */
const donateWrapper = document.createElement("div");
donateWrapper.className = "donate-wrapper";
donateWrapper.innerHTML = `
  <svg class="hand-svg" viewBox="0 0 200 200" width="120" height="120" xmlns="http://www.w3.org/2000/svg">
    <path d="M 70 110 L 70 105 80 105 80 130 70 130 70 110" fill="skyblue" stroke="#888" stroke-width="2"/>
    <path d="M 80 107.5 L 92 101 95 101 110 107 115 108 116 109 118 113 114 116 97 112" fill="none" stroke="#888" stroke-width="2"/>
    <path d="M 80 127 L 104 132 120 125 135 110 135 104 130 104 117 113" fill="none" stroke="#888" stroke-width="2"/>
    <path d="M 76 125 L 73 125" fill="none" stroke="#888" stroke-width="2"/>
  </svg>
  <div class="donate-icon">
    <div class="coin-container">
      <div class="coin">
        <div class="coin-face front">$</div>
        <div class="coin-face back">‚Çπ</div>
      </div>
    </div>
  </div>
`;
headerRight.appendChild(donateWrapper);

/* ===== Append Left + Right to Header ===== */
header.append(headerLeft, headerRight);
layout.appendChild(header);

/* ===== Dark/Light CSS ===== */
const style = document.createElement("style");
style.textContent = `
  body.dark {
    background-color: #121212;
    color: #eaeaea;
    transition: background 0.3s, color 0.3s;
  }
  body.dark .app-header { background-color: #1e1e1e !important; color: #fff; }
  body.dark input, body.dark textarea { background-color: #2c2c2c; color: #eaeaea; border: 1px solid #555; }
  body.dark button { background-color: #333; color: #fff; border-color: #555; }
  
  .header-right { position: relative; }
  .donate-wrapper { position: relative; display: inline-block; width: 120px; height: 150px; overflow: visible; vertical-align: middle; }
  .hand-svg { display: block; width: 100%; height: auto; }
  .donate-icon { position: absolute; bottom: 95px; left: 55%; transform: translateX(-50%); width: 32px; height: 32px; cursor: pointer; z-index: 2; }
  .coin-container { width: 100%; height: 100%; perspective: 600px; }
  .coin { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; animation: floatCoin 1.5s ease-in-out infinite, rotateCoin 2s linear infinite; }
  .coin-face { position: absolute; width: 100%; height: 100%; border-radius: 50%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: bold; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5), 0 -1px 2px rgba(255,255,255,0.4); border: 2px solid #B8860B; background: radial-gradient(circle at 30% 30%, #FFD84C 0%, #D4A017 55%, #8B5E00 100%); font-family: "Arial", "Segoe UI", "Noto Sans", sans-serif; }
  .coin-face.back { transform: rotateY(180deg); }
  @keyframes floatCoin { 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-10px); } }
  @keyframes rotateCoin { 0%{ transform: rotateY(0deg); } 50%{ transform: rotateY(180deg); } 100%{ transform: rotateY(360deg); } }
`;
document.head.appendChild(style);

/* ===== Dark/Light Toggle Logic ===== */
themeToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark");
  if (document.body.classList.contains("dark")) {
    themeIcon.innerHTML = `<path d="M21 12.79A9 9 0 0 1 11.21 3 a7 7 0 1 0 8.58 8.58z"></path>`;
    localStorage.setItem("theme", "dark");
  } else {
    themeIcon.innerHTML = `
      <circle cx="12" cy="12" r="5"></circle>
      <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42
               M18.36 18.36l1.42 1.42M1 12h2M21 12h2
               M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>`;
    localStorage.setItem("theme", "light");
  }
});

/* ===== Restore theme on load ===== */
if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark");
  themeIcon.innerHTML = `<path d="M21 12.79A9 9 0 0 1 11.21 3 a7 7 0 1 0 8.58 8.58z"></path>`;
}
// ===== Click event for donation panel =====
donateWrapper.addEventListener("click", () => {
  let donationPanel = document.querySelector(".donation-panel");

  if (!donationPanel) {
    donationPanel = document.createElement("div");
    donationPanel.className = "donation-panel";
    donationPanel.style.display = "flex";
    donationPanel.style.flexDirection = "column";
    donationPanel.style.gap = "14px";
    donationPanel.style.padding = "14px";
    donationPanel.style.position = "absolute";
    donationPanel.style.top = "80px";
    donationPanel.style.right = "12px";
    donationPanel.style.background = "#fff";
    donationPanel.style.border = "1px solid #ccc";
    donationPanel.style.borderRadius = "8px";
    donationPanel.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";

    donationPanel.innerHTML = `
      <p><strong>Support Us</strong></p>

      <!-- PayPal -->
      <div style="display:flex;flex-direction:column;gap:6px;">
        <div style="display:flex;align-items:center;gap:6px;">
          <span style="font-weight:bold;">$</span>
          <input id="paypalAmount" type="number" placeholder="Enter USD amount"
                 style="padding:6px;border:1px solid #ccc;border-radius:4px;width:120px;"/>
        </div>
        <img id="paypalBtn" 
             src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg"
             alt="Pay with PayPal"
             style="width:140px;height:auto;cursor:pointer;object-fit:contain;"/>
      </div>

      <!-- GPay -->
      <div style="display:flex;flex-direction:column;gap:6px;">
        <div style="display:flex;align-items:center;gap:6px;">
          <span style="font-weight:bold;">‚Çπ</span>
          <input id="gpayAmount" type="number" placeholder="Enter INR amount"
                 style="padding:6px;border:1px solid #ccc;border-radius:4px;width:120px;"/>
        </div>
        <img id="gpayBtn"
             src="https://upload.wikimedia.org/wikipedia/commons/c/c7/Google_Pay_Logo_%282020%29.svg"
             alt="Pay with GPay"
             style="width:160px;height:auto;cursor:pointer;object-fit:contain;"/>
      </div>
    `;

    document.body.appendChild(donationPanel);

    donationPanel.querySelector("#paypalBtn").addEventListener("click", () => {
      const amount = document.querySelector("#paypalAmount").value || "";
      if (amount) {
        window.open(`https://www.paypal.com/paypalme/YourUserName/${amount}`, "_blank");
        donationPanel.style.display = "none";
      } else {
        alert("Please enter an amount in USD ($).");
      }
    });

    donationPanel.querySelector("#gpayBtn").addEventListener("click", () => {
      const amount = document.querySelector("#gpayAmount").value || "";
      if (amount) {
        window.open(`upi://pay?pa=yourupi@bank&pn=YourName&am=${amount}&cu=INR`, "_blank");
        donationPanel.style.display = "none";
      } else {
        alert("Please enter an amount in INR (‚Çπ).");
      }
    });
  } else {
    donationPanel.style.display =
      donationPanel.style.display === "flex" ? "none" : "flex";
  }
});

headerRight.appendChild(donateWrapper);
header.append(headerLeft, headerRight);
layout.appendChild(header);
// ===== Initialize Vendor Search & Profile Link =====
// =======================
// storage.js + vendor-search.js
// =======================

// ===== Generic localStorage Helpers =====
function saveToLocalStorage(key, value) {
    try {
        var jsonValue = JSON.stringify(value);
        localStorage.setItem(key, jsonValue);
        console.log("Saved data to localStorage under key " + key);
    } catch (error) {
        console.error("Error saving to localStorage:", error);
    }
}

function getFromLocalStorage(key) {
    try {
        var jsonValue = localStorage.getItem(key);
        return jsonValue ? JSON.parse(jsonValue) : null;
    } catch (error) {
        console.error("Error reading from localStorage:", error);
        return null;
    }
}

function updateLocalStorage(key, newValue) {
    try {
        var existingValue = getFromLocalStorage(key);
        if (existingValue && typeof existingValue === "object") {
            var updatedValue = Object.assign({}, existingValue, newValue);
            saveToLocalStorage(key, updatedValue);
        } else {
            saveToLocalStorage(key, newValue);
        }
        console.log("Updated data for key " + key);
    } catch (error) {
        console.error("Error updating localStorage:", error);
    }
}

function deleteFromLocalStorage(key) {
    try {
        localStorage.removeItem(key);
        console.log("Deleted key " + key + " from localStorage");
    } catch (error) {
        console.error("Error deleting from localStorage:", error);
    }
}

function clearLocalStorage() {
    try {
        localStorage.clear();
        console.log("Cleared all localStorage data");
    } catch (error) {
        console.error("Error clearing localStorage:", error);
    }
}

// ===== Vendor-specific helpers =====
var VENDORS_KEY = "vendors";

function getVendors() {
    var stored = getFromLocalStorage(VENDORS_KEY) || [];
    // Only return registered vendors
    var filtered = [];
    for (var i = 0; i < stored.length; i++) {
        if (stored[i].registered) filtered.push(stored[i]);
    }
    return filtered;
}

function hasVendors() {
    var vendors = getVendors();
    return vendors.length > 0;
}

function addVendor(vendor) {
    var vendors = getFromLocalStorage(VENDORS_KEY) || [];
    // Check for duplicate ID
    for (var i = 0; i < vendors.length; i++) {
        if (vendors[i].id === vendor.id) {
            console.warn("Vendor with id " + vendor.id + " already exists");
            return;
        }
    }
    vendors.push(vendor);
    saveToLocalStorage(VENDORS_KEY, vendors);
    console.log("Vendor " + vendor.name + " added successfully");
}

function updateVendor(id, updatedData) {
    var vendors = getFromLocalStorage(VENDORS_KEY) || [];
    var found = false;
    for (var i = 0; i < vendors.length; i++) {
        if (vendors[i].id === id) {
            vendors[i] = Object.assign({}, vendors[i], updatedData);
            found = true;
            break;
        }
    }
    if (found) {
        saveToLocalStorage(VENDORS_KEY, vendors);
        console.log("Vendor with id " + id + " updated successfully");
    } else {
        console.warn("Vendor with id " + id + " not found");
    }
}

function deleteVendor(id) {
    var vendors = getFromLocalStorage(VENDORS_KEY) || [];
    var filtered = [];
    for (var i = 0; i < vendors.length; i++) {
        if (vendors[i].id !== id) filtered.push(vendors[i]);
    }
    saveToLocalStorage(VENDORS_KEY, filtered);
    console.log("Vendor with id " + id + " deleted successfully");
}

function clearVendors() {
    deleteFromLocalStorage(VENDORS_KEY);
    console.log("All vendors cleared from localStorage");
}

function initVendors(defaultVendors) {
    if (!hasVendors() && defaultVendors && defaultVendors.length > 0) {
        saveToLocalStorage(VENDORS_KEY, defaultVendors);
        console.log("Default vendors initialized");
    }
}

// =======================
// Vendor Search & UI
// =======================

function renderVendors(vendors) {
    var container = document.getElementById("vendorCardsContainer");
    if (!container) {
        container = document.createElement("div");
        container.id = "vendorCardsContainer";
        container.style.cssText = "display:flex;flex-direction:column;gap:12px;padding:15px;max-height:80vh;overflow-y:auto;background:#f9f9f9;";
        var layout = document.querySelector(".layout") || document.body;
        layout.appendChild(container);
    }

    container.innerHTML = "";
    for (var i = 0; i < vendors.length; i++) {
        exhibitVendorBlock(vendors[i]);
    }
}

function moveVendorToTop(vendorId) {
    var container = document.getElementById("vendorCardsContainer");
    var card = document.getElementById("vendor-" + vendorId);
    if (!card || !container) return;

    container.insertBefore(card, container.firstChild);
    card.scrollIntoView({ behavior: "smooth", block: "start" });

    var originalBg = card.style.background;
    card.style.background = "#e6f7ff";
    setTimeout(function () { card.style.background = originalBg || "#fff"; }, 1500);
}

function searchVendor(query) {
    var vendors = getVendors();
    var matched = null;
    query = query.toLowerCase();
    for (var i = 0; i < vendors.length; i++) {
        var v = vendors[i];
        if ((v.firstName && v.firstName.toLowerCase().includes(query)) ||
            (v.lastName && v.lastName.toLowerCase().includes(query)) ||
            (v.restaurantName && v.restaurantName.toLowerCase().includes(query)) ||
            (v.location && v.location.toLowerCase().includes(query))) {
            matched = v;
            break;
        }
    }

    if (!matched) {
        alert("No registered vendor found üîé");
        return;
    }

    moveVendorToTop(matched.id);
}

function createUnifiedSearchBar() {
    var header = document.querySelector(".app-header") || document.body;
    if (document.getElementById("unifiedSearchBtn")) return;

    var wrapper = document.createElement("div");
    wrapper.className = "search-bar";
    wrapper.style.cssText = "display:flex;align-items:center;gap:8px;margin:10px auto;padding:6px 12px;width:90%;max-width:420px;border:1px solid #ccc;border-radius:30px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.08);";

    var input = document.createElement("input");
    input.id = "unifiedSearchInput";
    input.type = "text";
    input.placeholder = "Search vendor by name, restaurant, or location...";
    input.style.cssText = "flex:1;padding:8px 12px;font-size:16px;border:none;outline:none;background:#f9f9f9;border-radius:20px;";

    var button = document.createElement("button");
    button.id = "unifiedSearchBtn";
    button.textContent = "üîç";
    button.style.cssText = "font-size:18px;cursor:pointer;border:none;background:#007bff;color:#fff;padding:8px 12px;border-radius:50%;";

    wrapper.appendChild(input);
    wrapper.appendChild(button);
    header.insertAdjacentElement("afterend", wrapper);

    button.addEventListener("click", function () {
        var query = input.value.trim();
        if (!query) { alert("Please type something to search üîé"); return; }
        searchVendor(query);
    });

    input.addEventListener("keypress", function (e) {
        if (e.key === "Enter") button.click();
    });
}

function registerVendor(profileData) {
    var vendors = getFromLocalStorage(VENDORS_KEY) || [];
    var newId = vendors.length > 0 ? vendors[vendors.length - 1].id + 1 : 1;

    var newVendor = {
        id: newId,
        firstName: profileData.firstName || "Unknown",
        lastName: profileData.lastName || "Vendor",
        restaurantName: profileData.restaurantName || "Unnamed Restaurant",
        location: profileData.location || "Unknown Location",
        photo: profileData.photo || "images/default-profile.png",
        phone: profileData.phone || "",
        email: profileData.email || "",
        rating: 0,
        review: "",
        registered: true
    };

    vendors.push(newVendor);
    saveToLocalStorage(VENDORS_KEY, vendors);

    alert("Vendor registration successful üéâ");
    renderVendors(getVendors());
}

function exhibitVendorBlock(profileData) {
    var container = document.getElementById("vendorCardsContainer");
    if (!container) return;

    var block = document.createElement("div");
    block.className = "vendor-block";
    block.id = "vendor-" + profileData.id;

    block.innerHTML = "<div class='vendor-header'>" +
        "<img src='" + profileData.photo + "' class='vendor-profile-photo' alt='Vendor Profile' />" +
        "<div class='vendor-id-chip'>Vendor ID: <strong>" + profileData.id + "</strong></div>" +
        "</div>" +
        generateDishGallery() +
        "<div class='vendor-card'>" +
        "<div class='vendor-info-layer'>" +
        "<h3>" + profileData.firstName + " " + profileData.lastName + "</h3>" +
        "<div class='vendor-details'>üìû " + (profileData.phone || "Unknown number") + "<br>" +
        "‚úâÔ∏è " + (profileData.email || "hotel@example.com") + "<br>" +
        "üìç " + (profileData.location || "Location not registered") + "</div>" +
        "</div></div>";

    container.appendChild(block);
    initDishGallery(block);
}

function generateDishGallery() {
    return "<div class='dish-gallery-wrapper'>" +
        "<button class='scroll-btn left-btn'><</button>" +
        "<div class='dish-scroll-strip'>" +
        "<div class='dish-item'>" +
        "<div class='dish-preview-container'>" +
        "<img src='static/placeholders/blank-dish.svg' class='dish-preview' alt='Dish Preview' />" +
        "<label class='upload-overlay'>" +
        "<input type='file' class='dishUpload' accept='image/*' />" +
        "<span class='upload-icon'>+</span>" +
        "</label></div>" +
        "<input type='text' class='dish-name-input' placeholder='Dish Name' />" +
        "</div></div>" +
        "<button class='scroll-btn right-btn'>></button>" +
        "</div>";
}

function initDishGallery(scope) {
    var scrollStrip = scope.querySelector(".dish-scroll-strip");
    scope.querySelector(".left-btn")?.addEventListener("click", function () {
        scrollStrip.scrollBy({ left: -200, behavior: "smooth" });
    });
    scope.querySelector(".right-btn")?.addEventListener("click", function () {
        scrollStrip.scrollBy({ left: 200, behavior: "smooth" });
    });

    var uploads = scope.querySelectorAll(".dishUpload");
    for (var i = 0; i < uploads.length; i++) {
        (function (input) {
            input.addEventListener("change", function (e) {
                var file = e.target.files[0];
                if (!file) return;
                var reader = new FileReader();
                reader.onload = function (ev) {
                    var preview = e.target.closest(".dish-preview-container").querySelector(".dish-preview");
                    preview.src = ev.target.result;
                };
                reader.readAsDataURL(file);
            });
        })(uploads[i]);
    }
}

function initVendorSearchSystem() {
    createUnifiedSearchBar();
    var vendors = getVendors();
    if (vendors.length > 0) {
        renderVendors(vendors);
    } else {
        console.warn("No registered vendors found in localStorage");
    }
}

window.addEventListener("load", initVendorSearchSystem);
window.launchRazorpay = function () { alert("Launching Razorpay payment for $1..."); };
window.launchUPI = function () { alert("Launching UPI payment for ‚Çπ100..."); };
/* ===== PROFILE FORM ===== */
const profileFormWrapper = document.createElement("div");
profileFormWrapper.className = "profile-form-wrapper";
profileFormWrapper.style.display = "none";
profileFormWrapper.style.position = "absolute";
profileFormWrapper.style.top = "70px";
profileFormWrapper.style.left = "50%";
profileFormWrapper.style.transform = "translateX(-50%)";
profileFormWrapper.style.background = "#1e1e1e"; // Dark background
profileFormWrapper.style.border = "1px solid #444"; // Darker border
profileFormWrapper.style.borderRadius = "10px";
profileFormWrapper.style.boxShadow = "0 4px 12px rgba(0,0,0,0.3)";
profileFormWrapper.style.padding = "20px";
profileFormWrapper.style.zIndex = "1000";
profileFormWrapper.style.width = "340px";
profileFormWrapper.style.maxHeight = "90vh";
profileFormWrapper.style.overflowY = "auto";

/* === Header Row with Close Button === */
const headerRow = document.createElement("div");
headerRow.style.display = "flex";
headerRow.style.justifyContent = "space-between";
headerRow.style.alignItems = "center";
headerRow.style.marginBottom = "10px";

const formTitle = document.createElement("h3");
formTitle.textContent = "Vendor Onboarding";
formTitle.style.margin = "0";
formTitle.style.fontSize = "16px";
formTitle.style.color = "#f0f0f0"; // Light text for dark background

const closeBtn = document.createElement("button");
closeBtn.textContent = "‚ùå";
closeBtn.style.border = "none";
closeBtn.style.background = "transparent";
closeBtn.style.cursor = "pointer";
closeBtn.style.fontSize = "18px";
closeBtn.style.lineHeight = "1";
closeBtn.style.color = "#f0f0f0"; // Light icon for dark background
closeBtn.addEventListener("click", () => {
  profileFormWrapper.style.display = "none";
});

headerRow.append(formTitle, closeBtn);

const form = document.createElement("form");
form.id = "vendorForm";

/* === Inputs === */
const firstNameInput = document.createElement("input");
firstNameInput.placeholder = "First Name";
firstNameInput.required = true;

const lastNameInput = document.createElement("input");
lastNameInput.placeholder = "Last Name";
lastNameInput.required = true;

const restaurantNameInput = document.createElement("input");
restaurantNameInput.placeholder = "Hotel/Restaurant Name";
restaurantNameInput.required = true;
restaurantNameInput.className = "vendor-restaurant-name-input";

/* === Phone === */
const countryCodeSelect = document.createElement("select");
countryCodeSelect.innerHTML = `
  <option value="+91">üáÆüá≥ +91</option>
  <option value="+1">üá∫üá∏ +1</option>
  <option value="+44">üá¨üáß +44</option>
`;

const phoneInput = document.createElement("input");
phoneInput.type = "tel";
phoneInput.placeholder = "Phone Number";
phoneInput.required = true;

const phoneOtpBtn = document.createElement("button");
phoneOtpBtn.type = "button";
phoneOtpBtn.textContent = "Send OTP to Phone";
phoneOtpBtn.className = "phone-otp-btn";
phoneOtpBtn.addEventListener("click", () => {
  const fullPhone = countryCodeSelect.value + phoneInput.value.trim();
  if (!phoneInput.value.match(/^[0-9]{6,15}$/)) {
    alert("‚ùå Please enter a valid phone number");
    return;
  }
  const otp = Math.floor(100000 + Math.random() * 900000);
  sessionStorage.setItem("phoneOtp", otp);
  alert(`üì± OTP sent to ${fullPhone}\n\n(Mock OTP: ${otp})`);
  const entered = prompt("Enter OTP received on phone:");
  if (entered === otp.toString()) {
    alert("‚úÖ Phone number verified!");
    phoneOtpBtn.disabled = true;
    phoneOtpBtn.textContent = "Phone Verified ‚úÖ";
  } else alert("‚ùå Incorrect OTP. Try again!");
});

const phoneWrapper = document.createElement("div");
phoneWrapper.className = "phone-wrapper";
phoneWrapper.style.display = "flex";
phoneWrapper.style.flexDirection = "column";
phoneWrapper.append(countryCodeSelect, phoneInput, phoneOtpBtn);
/* === Location === */
const locationWrapper = document.createElement("div");
locationWrapper.className = "location-wrapper";
locationWrapper.style.display = "flex";
locationWrapper.style.alignItems = "center";
locationWrapper.style.gap = "6px";

/* Create SVG icon using currentColor */
const locationIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
locationIcon.setAttribute("viewBox", "0 0 24 24");
locationIcon.setAttribute("width", "20");
locationIcon.setAttribute("height", "20");
locationIcon.style.cursor = "pointer";
locationIcon.innerHTML = `<path fill="currentColor" d="M12 2C8.1 2 5 5.1 5 9c0 5.2 7 13 7 13s7-7.8 7-13c0-3.9-3.1-7-7-7zm0 9.5c-1.4 0-2.5-1.1-2.5-2.5S10.6 6.5 12 6.5s2.5 1.1 2.5 2.5S13.4 11.5 12 11.5z"/>`;

/* Create input */
const locationInput = document.createElement("input");
locationInput.placeholder = "Location";
locationInput.required = true;

/* Apply dark/light mode colors dynamically */
function updateLocationColors() {
  const style = getComputedStyle(document.documentElement);
  const textColor = style.getPropertyValue("--text-color").trim() || "#222";
  const inputBg = style.getPropertyValue("--input-bg").trim() || "#fff";
  const inputBorder = style.getPropertyValue("--input-border").trim() || "#ccc";

  locationIcon.style.color = textColor;       // SVG follows currentColor
  locationInput.style.color = textColor;
  locationInput.style.backgroundColor = inputBg;
  locationInput.style.border = `1px solid ${inputBorder}`;
  locationInput.style.borderRadius = "6px";
  locationInput.style.padding = "6px 8px";
  locationInput.style.fontSize = "15px";
  locationInput.style.boxSizing = "border-box";
}

/* Initial color setup */
updateLocationColors();

/* Listen to dark mode toggle dynamically */
new MutationObserver(updateLocationColors).observe(document.body, { attributes: true, attributeFilter: ["class"] });

/* Click handler for Google Maps */
locationIcon.addEventListener("click", () => {
  if (!locationInput.value.trim()) {
    alert("Enter location first!");
    return;
  }
  window.open(
    `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(locationInput.value)}`,
    "_blank"
  );
});

locationWrapper.append(locationIcon, locationInput);
/* === Profile Upload === */
const profileUpload = document.createElement("input");
profileUpload.type = "file";
profileUpload.accept = "image/*";

const profilePreview = document.createElement("img");
profilePreview.className = "profile-preview";
profilePreview.style.width = "70px";
profilePreview.style.height = "70px";
profilePreview.style.borderRadius = "50%";
profilePreview.style.objectFit = "cover";
profilePreview.style.border = "2px solid #ddd";

/* === Other Inputs === */
const vendorIdInput = document.createElement("input");
vendorIdInput.placeholder = "Vendor ID (auto)";
vendorIdInput.readOnly = true;

const emailInput = document.createElement("input");
emailInput.type = "email";
emailInput.placeholder = "Email";
emailInput.required = true;

/* === Email OTP === */
const emailOtpBtn = document.createElement("button");
emailOtpBtn.type = "button";
emailOtpBtn.textContent = "Send OTP to Email";
emailOtpBtn.addEventListener("click", () => {
  const email = emailInput.value.trim();
  if (!email.match(/^[^@\s]+@[^@\s]+\.[^@\s]+$/)) {
    alert("‚ùå Enter a valid email address");
    return;
  }
  const otp = Math.floor(100000 + Math.random() * 900000);
  sessionStorage.setItem("emailOtp", otp);
  alert(`üìß OTP sent to ${email}\n\n(Mock OTP: ${otp})`);
  const entered = prompt("Enter OTP received on email:");
  if (entered === otp.toString()) {
    alert("‚úÖ Email verified!");
    emailOtpBtn.disabled = true;
    emailOtpBtn.textContent = "Email Verified ‚úÖ";
  } else alert("‚ùå Incorrect OTP. Try again!");
});

/* === Passwords === */
const passInput = document.createElement("input");
passInput.type = "password";
passInput.placeholder = "Password";
passInput.required = true;

const confirmInput = document.createElement("input");
confirmInput.type = "password";
confirmInput.placeholder = "Confirm Password";
confirmInput.required = true;

/* === Buttons === */
const submitBtn = document.createElement("button");
submitBtn.type = "submit";
submitBtn.textContent = "Register Vendor";

const logoutBtn = document.createElement("button");
logoutBtn.type = "button";
logoutBtn.textContent = "Logout";
logoutBtn.addEventListener("click", () => {
  form.reset();
  profilePreview.src = "";
  vendorIdInput.value = "";
  profileFormWrapper.style.display = "none";
  profileIcon.src = DEFAULT_PROFILE_ICON;
  alert("‚úÖ Logged out and cleared form");
});

/* === Append fields === */
form.append(
  firstNameInput, lastNameInput, restaurantNameInput,
  phoneWrapper, locationWrapper,
  profileUpload, profilePreview,
  vendorIdInput, emailInput, emailOtpBtn,
  passInput, confirmInput,
  submitBtn, logoutBtn
);
profileFormWrapper.append(headerRow, form);
layout.appendChild(profileFormWrapper);

/* === Toggle from profile icon === */
profileTrigger.addEventListener("click", () => {
  profileFormWrapper.style.display =
    profileFormWrapper.style.display === "none" ? "block" : "none";
});

/* === Profile Preview Update === */
profileUpload.addEventListener("change", e => {
  const f = e.target.files[0];
  if (!f || !ALLOWED_TYPES.includes(f.type)) {
    alert("‚ùå Invalid file type!");
    return;
  }
  const url = URL.createObjectURL(f);
  profilePreview.src = url;
  profileIcon.src = url;
});

/* === Password Toggle === */
function addPasswordToggle(input) {
  const wrapper = document.createElement("div");
  wrapper.style.position = "relative";
  input.parentNode.insertBefore(wrapper, input);
  wrapper.appendChild(input);

  const toggle = document.createElement("span");
  toggle.textContent = "üëÅÔ∏è";
  toggle.style.position = "absolute";
  toggle.style.right = "10px";
  toggle.style.top = "50%";
  toggle.style.transform = "translateY(-50%)";
  toggle.style.cursor = "pointer";

  toggle.addEventListener("click", () => {
    if (input.type === "password") {
      input.type = "text";
      toggle.textContent = "üôà";
    } else {
      input.type = "password";
      toggle.textContent = "üëÅÔ∏è";
    }
  });
  wrapper.appendChild(toggle);
}
addPasswordToggle(passInput);
addPasswordToggle(confirmInput);
//=== search bar ===
// ===== Vendor Cards Container =====
const vendorCardsContainer = document.createElement("div");
vendorCardsContainer.id = "vendorCardsContainer";
vendorCardsContainer.style.display = "flex";
vendorCardsContainer.style.flexDirection = "column";
vendorCardsContainer.style.gap = "12px";
vendorCardsContainer.style.padding = "15px";
vendorCardsContainer.style.maxHeight = "90vh";  // allows scrolling
vendorCardsContainer.style.overflowY = "auto";
vendorCardsContainer.style.background = document.body.classList.contains("dark") ? "#2c2c2c" : "#f9f9f9";
vendorCardsContainer.style.transition = "background 0.3s";
layout.appendChild(vendorCardsContainer);

// ===== Update background on dark/light toggle =====
document.getElementById("themeToggle")?.addEventListener("click", () => {
  vendorCardsContainer.style.background = document.body.classList.contains("dark") ? "#2c2c2c" : "#f9f9f9";
});

// ===== Vendor Cards Container (Fixed Layout Position) =====
function setupVendorCardsContainer() {
  // Try to find a proper place to insert vendor cards (main or vendor container)
  const mainBody = document.querySelector(".main-body, main, .vendor-container, .content, .profile-wrapper, #mainBody");
  if (!mainBody) {
    // Retry later if main body not yet loaded
    setTimeout(setupVendorCardsContainer, 300);
    return;
  }

  // Avoid duplicates
  if (document.querySelector("#vendorCardsContainer")) return;

  const vendorCardsContainer = document.createElement("div");
  vendorCardsContainer.id = "vendorCardsContainer";
  vendorCardsContainer.style.display = "flex";
  vendorCardsContainer.style.flexDirection = "column"; // stack vertically
  vendorCardsContainer.style.gap = "15px";
  vendorCardsContainer.style.maxHeight = "90vh";
  vendorCardsContainer.style.overflowY = "auto";
  vendorCardsContainer.style.padding = "15px";
  vendorCardsContainer.style.background = "#f9f9f9";
  vendorCardsContainer.style.borderRadius = "10px";
  vendorCardsContainer.style.marginTop = "20px";

  mainBody.appendChild(vendorCardsContainer);
}
setupVendorCardsContainer();

// ===== Add Vendor After Registration Success =====
let vendorIdCounter = 1;

function addNewVendor(vendorData = null) {
  const vendorCardsContainer = document.querySelector("#vendorCardsContainer");
  if (!vendorCardsContainer) return;

  const newVendor = new VendorBlock({
    id: vendorIdCounter,
    firstName: vendorData?.firstName || "Vendor" + vendorIdCounter,
    lastName: vendorData?.lastName || "Name",
    restaurantName: vendorData?.restaurantName || "Restaurant " + vendorIdCounter,
    email: vendorData?.email || `vendor${vendorIdCounter}@example.com`,
    phone: vendorData?.phone || "1234567890",
    location: vendorData?.location || "City " + vendorIdCounter
  });

  vendors.push(newVendor);
  newVendor.renderTo(vendorCardsContainer);
  vendorIdCounter++;
}
/* ===== Vendor Block Class ===== */
class VendorBlock {
  constructor(data) {
    this.data = data;
    this.dishes = [];
    this.maxDishes = 3;
    this.review = "";
    this.rating = 0;
  }

  renderTo(container) {
const block = document.createElement("div");
block.className = "vendor-block";
block.style.border = "1px solid #ccc";
block.style.padding = "12px";
block.style.margin = "12px 0";
block.style.borderRadius = "8px";
block.style.background = "#fff";
block.style.color = "#000";               // default text color
block.style.transition = "background 0.3s, color 0.3s, border-color 0.3s";

// ===== Dark mode check =====
if (document.body.classList.contains("dark")) {
  block.style.background = "#2c2c2c";
  block.style.color = "#eaeaea";
  block.style.borderColor = "#555";
}

// ===== Vendor Header =====
const header = document.createElement("div");
header.style.display = "flex";
header.style.alignItems = "center";
header.style.gap = "12px";

// ===== Avatar =====
const avatar = document.createElement("img");
avatar.src =
  localStorage.getItem(`vendorProfile_${this.data.id}`) ||
  this.data.photo ||
  DEFAULT_PROFILE_ICON;
avatar.style.width = "80px";
avatar.style.height = "80px";
avatar.style.borderRadius = "50%";
avatar.style.objectFit = "cover";
avatar.style.cursor = "pointer";
avatar.title = "Click to update profile picture";

const fileInput = document.createElement("input");
fileInput.type = "file";
fileInput.accept = "image/*";
fileInput.style.display = "none";

// ‚úÖ Only open file selector, don't touch profile wrapper
avatar.addEventListener("click", () => {
  fileInput.click();
});

// ‚úÖ When image selected
fileInput.addEventListener("change", (event) => {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      avatar.src = e.target.result;
      if (typeof profileIcon !== "undefined" && profileIcon)
        profileIcon.src = e.target.result;

      // Save in localStorage
      localStorage.setItem(`vendorProfile_${this.data.id}`, e.target.result);
      localStorage.setItem("appHeaderProfile", e.target.result);

      // ‚úÖ Always ensure profile wrapper stays hidden
      const profileWrapper =
        document.querySelector(".profile-form-wrapper") ||
        document.getElementById("profileFormWrapper");
      if (profileWrapper) profileWrapper.style.display = "none";
    };
    reader.readAsDataURL(file);
  }
});
    // Vendor Info
    const infoText = document.createElement("div");
    infoText.innerHTML = `
      <h3>${this.data.firstName} ${this.data.lastName}</h3>
      <p>üè® ${this.data.restaurantName}</p>
      <p>üìß ${this.data.email}</p>
      <p>üìû ${this.data.phone}</p>
      <p>Vendor ID: ${this.data.id}</p>
    `;

    // Location
    const locPara = document.createElement("p");
    locPara.style.display = "flex";
    locPara.style.alignItems = "center";
    locPara.style.gap = "4px";
    const locIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    locIcon.setAttribute("viewBox", "0 0 24 24");
    locIcon.setAttribute("width", "14");
    locIcon.setAttribute("height", "14");
    locIcon.style.fill = "red";
    locIcon.innerHTML = `<path d="M12 2C8.1 2 5 5.1 5 9c0 5.2 7 13 7 13s7-7.8 7-13c0-3.9-3.1-7-7-7zm0 9.5c-1.4 0-2.5-1.1-2.5-2.5S10.6 6.5 12 6.5s2.5 1.1 2.5 2.5S13.4 11.5 12 11.5z"/>`;
    const locLink = document.createElement("a");
    locLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(this.data.location)}`;
    locLink.target = "_blank";
    locLink.style.color = "#444";
    locLink.style.textDecoration = "none";
    locLink.textContent = this.data.location;
    locPara.append(locIcon, locLink);
    infoText.appendChild(locPara);

    header.append(avatar, infoText, fileInput);
    block.appendChild(header);

// ===== Dish Row =====
const dishRow = document.createElement("div");
dishRow.style.display = "flex";
dishRow.style.overflowX = "auto";
dishRow.style.gap = "16px";
dishRow.style.padding = "12px 0";
block.appendChild(dishRow);

// ===== Plus Button =====
const plusLabel = document.createElement("div");
plusLabel.textContent = "+";
plusLabel.style.width = "220px";
plusLabel.style.height = "220px";
plusLabel.style.display = "flex";
plusLabel.style.alignItems = "center";
plusLabel.style.justifyContent = "center";
plusLabel.style.fontSize = "64px";
plusLabel.style.border = "2px dashed #aaa";
plusLabel.style.borderRadius = "16px";
plusLabel.style.cursor = "pointer";
plusLabel.style.color = "#555";
plusLabel.style.background = "#fafafa";
plusLabel.style.transition = "all 0.2s ease";
plusLabel.addEventListener("mouseenter", () => {
  plusLabel.style.transform = "scale(1.05)";
  plusLabel.style.borderColor = "#666";
});
plusLabel.addEventListener("mouseleave", () => {
  plusLabel.style.transform = "scale(1)";
  plusLabel.style.borderColor = "#aaa";
});
dishRow.appendChild(plusLabel);

// ===== Upgrade Tail with Pay Buttons =====
const upgradeTail = document.createElement("div");
upgradeTail.style.width = "220px";
upgradeTail.style.height = "220px";
upgradeTail.style.display = "none";
upgradeTail.style.flexDirection = "column";
upgradeTail.style.alignItems = "center";
upgradeTail.style.justifyContent = "center";
upgradeTail.style.border = "2px solid #ffcc00";
upgradeTail.style.borderRadius = "18px";
upgradeTail.style.background = "linear-gradient(145deg, #fff8e1, #fff3c4)";
upgradeTail.style.boxShadow = "0 4px 15px rgba(255, 204, 0, 0.3)";
upgradeTail.style.fontWeight = "600";
upgradeTail.style.color = "#8a6d00";
upgradeTail.style.cursor = "default";
upgradeTail.style.textAlign = "center";
upgradeTail.style.gap = "12px";
upgradeTail.style.transition = "transform 0.3s ease, box-shadow 0.3s ease";

upgradeTail.innerHTML = `
  <p style="margin: 0 0 10px; font-size:15px;">‚ú® Upgrade to add 10 more dishes üçΩÔ∏è</p>
  <div style="display:flex; flex-direction:column; gap:10px; align-items:center; justify-content:center;">
    <button id="paypalBtn"
      style="
        display:flex; align-items:center; justify-content:center;
        gap:8px; background:#0070ba; color:#fff;
        border:none; border-radius:8px;
        padding:8px 12px; width:160px;
        font-size:14px; cursor:pointer;
        transition:transform 0.2s ease, box-shadow 0.2s ease;
      ">
      <img src='https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg'
           alt='PayPal' style='width:24px; height:auto;'>
      Pay $1
    </button>

    <button id="gpayBtn"
      style="
        display:flex; align-items:center; justify-content:center;
        gap:8px; background:#000; color:#fff;
        border:none; border-radius:8px;
        padding:8px 12px; width:160px;
        font-size:14px; cursor:pointer;
        transition:transform 0.2s ease, box-shadow 0.2s ease;
      ">
      <img src='https://pay.google.com/about/static/images/logos/google-pay-logo.svg'
           alt='GPay' style='width:28px; height:auto;'>
      Pay ‚Çπ100
    </button>
  </div>
`;

upgradeTail.querySelectorAll("button").forEach(btn => {
  btn.addEventListener("mouseenter", () => {
    btn.style.transform = "scale(1.05)";
    btn.style.boxShadow = "0 3px 8px rgba(0,0,0,0.25)";
  });
  btn.addEventListener("mouseleave", () => {
    btn.style.transform = "scale(1)";
    btn.style.boxShadow = "none";
  });
});

dishRow.appendChild(upgradeTail);

// ===== Upgrade Button Actions =====
upgradeTail.querySelector("#paypalBtn").addEventListener("click", () => {
  alert("üí≥ Redirecting to PayPal for $1 (Demo)");
  this.maxDishes += 10;
  plusLabel.style.display = "flex";
  upgradeTail.style.display = "none";
});

upgradeTail.querySelector("#gpayBtn").addEventListener("click", () => {
  alert("üí∏ Redirecting to Google Pay for ‚Çπ100 (Demo)");
  this.maxDishes += 10;
  plusLabel.style.display = "flex";
  upgradeTail.style.display = "none";
});

// ===== Add Dish Function (with editable name input) =====
const addDish = (url, name, fileObj, index) => {
  const dishWrapper = document.createElement("div");
  dishWrapper.style.width = "220px";
  dishWrapper.style.flex = "0 0 auto";
  dishWrapper.style.position = "relative";
  dishWrapper.style.display = "flex";
  dishWrapper.style.flexDirection = "column";
  dishWrapper.style.alignItems = "center";
  dishWrapper.style.background = "#fff";
  dishWrapper.style.border = "1px solid #ddd";
  dishWrapper.style.borderRadius = "16px";
  dishWrapper.style.overflow = "hidden";
  dishWrapper.style.boxShadow = "0 3px 8px rgba(0,0,0,0.1)";
  dishWrapper.style.transition = "transform 0.2s ease, box-shadow 0.2s ease";

  // Dish image
  const img = document.createElement("img");
  img.src = url;
  img.alt = name;
  img.style.width = "100%";
  img.style.height = "180px";
  img.style.objectFit = "cover";
  dishWrapper.appendChild(img);

  // Editable dish name input
  const dishNameInput = document.createElement("input");
  dishNameInput.type = "text";
  dishNameInput.placeholder = "Enter dish name...";
  dishNameInput.style.width = "90%";
  dishNameInput.style.margin = "6px 0 10px";
  dishNameInput.style.padding = "6px";
  dishNameInput.style.border = "1px solid #ccc";
  dishNameInput.style.borderRadius = "6px";
  dishNameInput.style.fontSize = "14px";
  dishNameInput.style.textAlign = "center";

  // Load previously saved name
  const vendorKey = `dishName_${this.data.id}_${index}`;
  const savedName = localStorage.getItem(vendorKey);
  if (savedName) dishNameInput.value = savedName;

  // Save name on change
  dishNameInput.addEventListener("change", () => {
    localStorage.setItem(vendorKey, dishNameInput.value.trim());
  });

  dishWrapper.appendChild(dishNameInput);

  // Remove button
  const removeBtn = document.createElement("button");
  removeBtn.textContent = "‚úñ";
  removeBtn.style.position = "absolute";
  removeBtn.style.top = "6px";
  removeBtn.style.right = "6px";
  removeBtn.style.background = "rgba(0,0,0,0.6)";
  removeBtn.style.color = "#fff";
  removeBtn.style.border = "none";
  removeBtn.style.borderRadius = "50%";
  removeBtn.style.width = "28px";
  removeBtn.style.height = "28px";
  removeBtn.style.cursor = "pointer";
  removeBtn.addEventListener("click", () => {
    localStorage.removeItem(vendorKey);
    dishWrapper.remove();
    this.dishes = this.dishes.filter(d => d.file !== fileObj);
    if (this.dishes.length < this.maxDishes) {
      plusLabel.style.display = "flex";
      upgradeTail.style.display = "none";
    }
  });
  dishWrapper.appendChild(removeBtn);

  dishRow.insertBefore(dishWrapper, plusLabel);
};

// ===== Plus Button Click Event =====
plusLabel.addEventListener("click", () => {
  if (this.dishes.length >= this.maxDishes) {
    plusLabel.style.display = "none";
    upgradeTail.style.display = "flex";
    return;
  }

  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.style.display = "none";
  input.addEventListener("change", (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    const index = this.dishes.length;
    addDish(url, f.name, f, index);
    this.dishes.push({ file: f, name: f.name });

    if (this.dishes.length >= this.maxDishes) {
      plusLabel.style.display = "none";
      upgradeTail.style.display = "flex";
    }
  });
  input.click();
});
    // ===== Rating =====
    const ratingWrapper = document.createElement("div");
    ratingWrapper.className = "rating-wrapper";
    ratingWrapper.style.marginTop = "8px";
    for (let i = 1; i <= 5; i++) {
      const star = document.createElement("span");
      star.textContent = "‚òÖ";
      star.style.cursor = "pointer";
      star.addEventListener("click", () => {
        this.rating = i;
        ratingWrapper.querySelectorAll("span").forEach((s, idx) => {
          s.style.color = idx < i ? "#f5b50a" : "#ccc";
        });
      });
      ratingWrapper.appendChild(star);
    }
    block.appendChild(ratingWrapper);

    // ===== Review =====
    const reviewWrapper = document.createElement("div");
    reviewWrapper.className = "review-wrapper";
    reviewWrapper.style.marginTop = "8px";
    const reviewLabel = document.createElement("label");
    reviewLabel.textContent = "Write a review:";
    const reviewBox = document.createElement("textarea");
    reviewBox.placeholder = "Share your feedback...";
    reviewBox.style.width = "100%";
    reviewBox.style.minHeight = "40px";
    reviewBox.addEventListener("input", () => { this.review = reviewBox.value; });
    reviewWrapper.append(reviewLabel, reviewBox);
    block.appendChild(reviewWrapper);

    // Submit Review Button
    const submitReviewBtn = document.createElement("button");
    submitReviewBtn.type = "button";
    submitReviewBtn.textContent = "Submit Review & Rating";
    submitReviewBtn.style.marginTop = "6px";
    submitReviewBtn.style.background = "#28a745";
    submitReviewBtn.style.color = "#fff";
    submitReviewBtn.style.border = "none";
    submitReviewBtn.style.padding = "6px 10px";
    submitReviewBtn.style.borderRadius = "6px";
    submitReviewBtn.style.cursor = "pointer";
    submitReviewBtn.addEventListener("click", () => {
      if (this.rating === 0 && !this.review.trim()) { alert("‚ö†Ô∏è Please provide a rating or review first!"); return; }
      alert(`‚≠ê Rating: ${this.rating}\nüìù Review: ${this.review}`);
      submitReviewBtn.disabled = true;
      submitReviewBtn.textContent = "Submitted ‚úÖ";
    });
    block.appendChild(submitReviewBtn);

    // ===== Logout Button =====
    const logoutBtn = document.createElement("button");
    logoutBtn.type = "button";
    logoutBtn.textContent = "Logout Vendor";
    logoutBtn.style.marginTop = "6px";
    logoutBtn.style.background = "#ff4d4f";
    logoutBtn.style.color = "#fff";
    logoutBtn.style.border = "none";
    logoutBtn.style.padding = "6px 10px";
    logoutBtn.style.borderRadius = "6px";
    logoutBtn.style.cursor = "pointer";
    logoutBtn.addEventListener("click", () => {
      block.remove();
      const index = vendors.indexOf(this);
      if (index > -1) vendors.splice(index, 1);
      alert(`‚úÖ Vendor ${this.data.firstName} ${this.data.lastName} logged out.`);
    });
    block.appendChild(logoutBtn);

    container.appendChild(block);
  }

  addDish(container, url, name) {
    const dishBox = document.createElement("div");
    dishBox.className = "dish-box";
    dishBox.style.position = "relative";
    const img = document.createElement("img");
    img.src = url;
    img.style.width = "80px";
    img.style.height = "80px";
    img.style.borderRadius = "6px";
    img.style.objectFit = "cover";
    dishBox.appendChild(img);

    const removeBtn = document.createElement("div");
    removeBtn.textContent = "‚úñ";
    removeBtn.style.position = "absolute";
    removeBtn.style.top = "2px";
    removeBtn.style.right = "2px";
    removeBtn.style.background = "#ff4d4f";
    removeBtn.style.color = "#fff";
    removeBtn.style.borderRadius = "50%";
    removeBtn.style.width = "18px";
    removeBtn.style.height = "18px";
    removeBtn.style.display = "flex";
    removeBtn.style.justifyContent = "center";
    removeBtn.style.alignItems = "center";
    removeBtn.style.cursor = "pointer";
    removeBtn.addEventListener("click", () => {
      dishBox.remove();
      this.dishes = this.dishes.filter(d => d.name !== name);
    });
    dishBox.appendChild(removeBtn);

    container.insertBefore(dishBox, container.querySelector(".plus-label"));
  
    container.appendChild(block);
  }
}

//=== form submit=====
let vendorRegistered = false; // Track vendor registration status

form.addEventListener("submit", e => {
  e.preventDefault();

  // Prevent re-registration
  if (vendorRegistered) {
    alert("‚ö†Ô∏è Vendor already registered. Please logout first to register a new one.");
    return;
  }

  // OTP verification checks
  const phoneVerified = phoneOtpBtn.disabled;
  const emailVerified = emailOtpBtn.disabled;

  if (!phoneVerified || !emailVerified) {
    alert("‚ùå Please verify both Phone and Email OTPs before submitting!");
    return;
  }

  // Check password match
  if (passInput.value !== confirmInput.value) {
    alert("‚ùå Passwords do not match!");
    return;
  }

  // Generate vendor ID
  const vendorId = "VND-" + Math.floor(Math.random() * 100000);
  vendorIdInput.value = vendorId;

  // Collect vendor data
  const vendorData = {
    firstName: firstNameInput.value,
    lastName: lastNameInput.value,
    restaurantName: restaurantNameInput.value,
    phone: countryCodeSelect.value + phoneInput.value,
    location: locationInput.value,
    email: emailInput.value,
    id: vendorId,
    photo: profilePreview.src || DEFAULT_PROFILE_ICON,
    maxDishes: DEFAULT_MAX_DISHES
  };

  // Create VendorBlock and store
  const vb = new VendorBlock(vendorData);
  vendors.push(vb);

  // Clear container and re-render all vendor cards
  vendorCardsContainer.innerHTML = "";
  vendors.forEach(v => {
    v.renderTo(vendorCardsContainer);

    // ===== Donation Icon =====
    const donateIcon = document.createElement("div");
    donateIcon.className = "donate-icon";
    donateIcon.title = "Donate";
    donateIcon.style.cursor = "pointer";
    donateIcon.style.marginTop = "6px";

    // Toggle donation panel
    donateIcon.addEventListener("click", () => {
      const panel = v.donationPanel || createDonationPanel(v);
      panel.style.display = panel.style.display === "flex" ? "none" : "flex";
    });

    // Attach safely before rating if exists
    const block = vendorCardsContainer.lastChild;
    const rating = block.querySelector(".rating-wrapper");
    if (rating) {
      rating.before(donateIcon);
    } else {
      block.appendChild(donateIcon);
    }
  });

  // Auto-scroll to last added vendor
  vendorCardsContainer.lastChild.scrollIntoView({ behavior: "smooth" });

  // Save registration session
  vendorRegistered = true;
  localStorage.setItem("vendorRegistered", "true");
  localStorage.setItem("vendorId", vendorId);

  // Clear form & hide
  form.reset();
  profilePreview.src = "";
  profileFormWrapper.style.display = "none";
  profileIcon.src = DEFAULT_PROFILE_ICON;

  alert(`‚úÖ Vendor ${vendorData.firstName} registered successfully!`);
});

/* ===== Restore Vendor Session on Reload ===== */
if (localStorage.getItem("vendorRegistered") === "true") {
  vendorRegistered = true;
  vendorIdInput.value = localStorage.getItem("vendorId") || "EXISTING";
}

/* ===== Logout Logic ===== */
logoutBtn.addEventListener("click", () => {
  form.reset();
  profilePreview.src = "";
  vendorIdInput.value = "";
  vendorRegistered = false;
  localStorage.removeItem("vendorRegistered");
  localStorage.removeItem("vendorId");
  profileIcon.src = DEFAULT_PROFILE_ICON;
  Array.from(form.elements).forEach(el => (el.disabled = false));
  alert("‚úÖ Logged out and cleared vendor data.");
});

// ===== Helper: Create Donation Panel =====
function createDonationPanel(vendor) {
  const panel = document.createElement("div");
  panel.className = "donation-panel";
  panel.style.display = "flex"; // default open on create
  panel.style.flexDirection = "column";
  panel.style.gap = "8px";
  panel.style.marginTop = "6px";
  panel.style.padding = "10px";
  panel.style.border = "1px solid #ccc";
  panel.style.borderRadius = "6px";
  panel.style.background = "#fff";

  panel.innerHTML = `
    <p>Support ${vendor.data.firstName}!</p>
    <button class="paypal-btn">PayPal $1</button>
    <button class="gpay-btn">GPay ‚Çπ100</button>
  `;

  // Attach to last vendor card
  vendorCardsContainer.lastChild.appendChild(panel);
  vendor.donationPanel = panel;

  // PayPal action
  panel.querySelector(".paypal-btn").addEventListener("click", () => {
    window.open("https://www.paypal.com/paypalme/YOUR_PAYPAL_ID/1", "_blank");
    panel.style.display = "none";
  });

  // GPay action
  panel.querySelector(".gpay-btn").addEventListener("click", () => {
    window.location.href = "upi://pay?pa=k19112177@okaxis&pn=MyVindhu&am=100&cu=INR";
    panel.style.display = "none";
  });

  return panel;
}
});
</script>
</body>
</html>
